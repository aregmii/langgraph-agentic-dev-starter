<!DOCTYPE html>
<html>
<head>
    <title>SSE Test - Code Agent</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad: false, theme: 'dark'});</script>
    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
        .container { max-width: 900px; margin: 0 auto; }
        #events { background: #2d2d2d; padding: 15px; border-radius: 8px; max-height: 400px; overflow-y: auto; margin: 15px 0; }
        /* Only show scrollbar when content overflows */
        #events:not(:has(.event:nth-child(6))) { overflow-y: hidden; }
        .event { margin: 8px 0; padding: 8px; border-radius: 4px; }
        .node_start { background: #264f78; }
        .node_complete { background: #2d5a2d; }
        .result { background: #4a4a2d; }
        .error { background: #5a2d2d; }
        .retry { background: #5a4a2d; }
        .plan_start { background: #4a2d5a; }
        .plan_analysis { background: #3d4a5a; }
        .plan_step_identified { background: #2d4a4a; }
        .plan_complete { background: #2d5a4a; }
        /* Module 12 Manager events */
        .manager_received_task { background: #4a2d5a; }
        .manager_plan { background: #2d5a4a; }
        .manager_planning_start { background: #4a2d5a; }
        .manager_planning_complete { background: #2d5a4a; }
        .manager_execution_start { background: #264f78; }
        .manager_delegating { background: #3d4a5a; }
        .manager_assembling { background: #4a4a2d; }
        .manager_complete { background: #2d5a2d; }
        /* Module 12 Stage/Step events */
        .stage_start { background: #264f78; }
        .stage_complete { background: #2d5a4a; }
        .step_complete { background: #2d5a2d; }
        /* Module 12 Agent events */
        .builder_complete { background: #2d5a2d; }
        .builder_planning_start { background: #3d4a5a; }
        .builder_planning_complete { background: #2d5a4a; }
        .builder_coding_start { background: #264f78; }
        .builder_coding_complete { background: #2d5a2d; }
        .reviewer_complete { background: #3d5a4d; }
        .reviewer_planning_start { background: #4a3d5a; }
        .reviewer_planning_complete { background: #4a5a3d; }
        .reviewer_validating_start { background: #264f78; }
        .reviewer_step_start { background: #3d4a5a; }
        .reviewer_step_complete { background: #2d5a4a; }
        .reviewer_validating_complete { background: #3d5a4d; }
        .docgen_start { background: #3d5a4a; }
        .docgen_complete { background: #4a5a3d; }
        /* Module 12 Reflection events */
        .reflection_start { background: #5a4a2d; }
        .reflection_complete { background: #4a5a2d; }
        button { padding: 10px 20px; font-size: 16px; margin: 10px 5px 10px 0; cursor: pointer; border: none; border-radius: 4px; }
        button:hover { opacity: 0.8; }
        .btn-run { background: #0e639c; color: white; }
        .btn-clear { background: #5a5a5a; color: white; }
        #code { background: #2d2d2d; padding: 15px; border-radius: 8px; white-space: pre-wrap; overflow-x: auto; }
        input { padding: 10px; width: 500px; font-size: 14px; border-radius: 4px; border: 1px solid #555; background: #2d2d2d; color: #d4d4d4; }
        .status { padding: 5px 10px; border-radius: 4px; display: inline-block; margin-left: 10px; }
        .status.idle { background: #5a5a5a; }
        .status.running { background: #0e639c; }
        .status.planning { background: #4a2d5a; }
        .status.success { background: #2d5a2d; }
        .status.error { background: #5a2d2d; }
        .metrics { background: #2d2d2d; padding: 10px 15px; border-radius: 8px; margin: 15px 0; display: flex; gap: 20px; flex-wrap: wrap; }
        .metric { text-align: center; }
        .metric-value { font-size: 24px; font-weight: bold; color: #4fc3f7; }
        .metric-label { font-size: 12px; color: #888; }
        #output {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: monospace;
            margin-top: 10px;
            border: 1px solid #444;
            min-height: 50px;
        }
        .btn-run-code { background: #2d5a2d; color: white; }
        .btn-run-code:hover { background: #3d6a3d; }
        .output-success { color: #4fc3f7; }
        .output-error { color: #f44336; }
        .output-time { color: #888; font-size: 12px; margin-top: 5px; }
        #plan-section {
            margin: 20px 0;
            padding: 15px;
            background: #252530;
            border-radius: 8px;
            border: 1px solid #444;
            display: none;
        }
        #plan-section h3 { margin-top: 0; color: #b39ddb; }
        #plan-info { margin-bottom: 10px; color: #aaa; }
        #plan-diagram {
            margin-top: 15px;
            overflow-x: auto;
            background: #1e1e1e;
            padding: 15px;
            border-radius: 8px;
        }
        .mermaid { background: transparent; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Code Agent - SSE Test</h1>

        <div>
            <input type="text" id="description" value="Write a Python function to calculate fibonacci numbers" placeholder="Describe your task...">
            <button class="btn-run" onclick="runTask()">‚ñ∂ Run Task</button>
            <button class="btn-clear" onclick="clearEvents()">Clear</button>
            <span id="status" class="status idle">Idle</span>
        </div>


        <div id="plan-section">
            <h3>üìã Manager's Plan</h3>
            <div id="plan-info"></div>
            <div id="plan-diagram"></div>
        </div>

        <h3>Events:</h3>
        <div id="events"><div class="event">Ready. Click "Run Task" to start.</div></div>

        <h3>Generated Code:</h3>
        <pre id="code"><code class="language-python">Waiting for result...</code></pre>
        <button class="btn-run-code" onclick="runCode()">‚ñ∂ Run Code</button>

        <h3>Output:</h3>
        <div id="output">Click "Run Code" to execute the generated code...</div>
        <div id="output-time" class="output-time"></div>
    </div>

    <script>
        function setStatus(status, text) {
            const el = document.getElementById('status');
            el.className = 'status ' + status;
            el.textContent = text;
        }

        function clearEvents() {
            document.getElementById('events').innerHTML = '<div class="event">Ready. Click "Run Task" to start.</div>';
            const codeEl = document.querySelector('#code code');
            codeEl.textContent = 'Waiting for result...';
            codeEl.className = 'language-python';  // Reset class for Prism
            document.getElementById('output').textContent = 'Click "Run Code" to execute the generated code...';
            document.getElementById('output-time').textContent = '';
            document.getElementById('plan-section').style.display = 'none';
            document.getElementById('plan-info').innerHTML = '';
            document.getElementById('plan-diagram').innerHTML = '';
            setStatus('idle', 'Idle');
        }

        async function runTask() {
            const description = document.getElementById('description').value;
            const eventsDiv = document.getElementById('events');
            eventsDiv.innerHTML = '';
            // Reset plan section
            document.getElementById('plan-section').style.display = 'none';
            document.getElementById('plan-info').innerHTML = '';
            document.getElementById('plan-diagram').innerHTML = '';
            setStatus('planning', 'Planning...');

            try {
                const response = await fetch('/api/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';  // Buffer for incomplete SSE messages

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    // Append new data to buffer
                    buffer += decoder.decode(value, { stream: true });

                    // Process complete SSE messages (delimited by double newline)
                    let boundary;
                    while ((boundary = buffer.indexOf('\n\n')) !== -1) {
                        const message = buffer.slice(0, boundary);
                        buffer = buffer.slice(boundary + 2);

                        // Skip empty messages
                        if (!message.trim()) continue;

                        // Extract JSON after "data: " prefix
                        // The message should be a single line: "data: {...}"
                        const dataPrefix = 'data: ';
                        const dataIndex = message.indexOf(dataPrefix);
                        if (dataIndex === -1) continue;
                        const jsonStr = message.slice(dataIndex + dataPrefix.length).trim();

                        let json;
                        try {
                            json = JSON.parse(jsonStr);
                        } catch (e) {
                            console.error('JSON parse error:', e, 'Data:', jsonStr);
                            continue;
                        }
                        const eventDiv = document.createElement('div');
                        eventDiv.className = 'event ' + json.event;

                        const time = new Date(json.timestamp).toLocaleTimeString();

                        // ========== Manager Events ==========
                        if (json.event === 'manager_received_task') {
                            document.getElementById('plan-section').style.display = 'block';
                            document.getElementById('plan-info').innerHTML = `<strong>Task:</strong> ${escapeHtml(json.task)}`;
                            eventDiv.textContent = `${time} üìã MANAGER - Received task`;
                            setStatus('planning', 'Planning...');
                        } else if (json.event === 'manager_plan') {
                            // steps is an array like ["Use SoftwareBuilderAgent to generate code", ...]
                            const stepsHtml = json.steps ? json.steps.map((s, i) => `${i+1}. ${s}`).join('<br>') : '';
                            document.getElementById('plan-info').innerHTML += `<br><br><strong>Plan:</strong><br>${stepsHtml}`;
                            document.getElementById('plan-info').innerHTML += `<br><br><strong>Team:</strong> ${escapeHtml(json.team_summary)}`;
                            // Show full plan in event
                            const planText = json.steps ? json.steps.map((s, i) => `${i+1}. ${s}`).join(' | ') : '';
                            eventDiv.textContent = `${time} ‚úÖ MANAGER - Plan: ${planText}`;
                        } else if (json.event === 'manager_delegating') {
                            eventDiv.textContent = `${time} üîÑ MANAGER - Delegated to ${json.agent} (${json.agent_id}) to ${json.action}`;
                        } else if (json.event === 'manager_execution_start') {
                            eventDiv.textContent = `${time} üöÄ MANAGER - Execution started`;
                            setStatus('running', 'Executing...');
                        } else if (json.event === 'manager_complete') {
                            const icon = json.success ? '‚úÖ' : '‚ùå';
                            const status = json.success ? 'SUCCESS' : 'FAILED';
                            eventDiv.textContent = `${time} ${icon} MANAGER - ${status} (${json.total_attempts} attempt(s), ${json.duration_ms}ms)`;
                            if (!json.success) {
                                eventDiv.className = 'event error';
                                if (json.error_message) {
                                    eventDiv.textContent += ` - ${json.error_message}`;
                                }
                            }
                        }
                        // ========== Builder Events ==========
                        else if (json.event === 'builder_planning_start') {
                            eventDiv.textContent = `${time} üî® BUILDER (${json.agent_id}) - Received task, planning implementation...`;
                        } else if (json.event === 'builder_planning_complete') {
                            // Show full plan, not truncated
                            eventDiv.textContent = `${time} üìã BUILDER (${json.agent_id}) - Plan: ${json.plan}`;
                        } else if (json.event === 'builder_coding_start') {
                            eventDiv.textContent = `${time} ‚ö° BUILDER (${json.agent_id}) - Generating code...`;
                        } else if (json.event === 'builder_coding_complete') {
                            eventDiv.textContent = `${time} ‚úÖ BUILDER (${json.agent_id}) - Generated ${json.code_lines} lines`;
                        }
                        // ========== Reviewer Events ==========
                        else if (json.event === 'reviewer_planning_start') {
                            eventDiv.textContent = `${time} üîç REVIEWER (${json.agent_id}) - Received code, planning validation (${json.code_lines} lines)...`;
                        } else if (json.event === 'reviewer_planning_complete') {
                            eventDiv.textContent = `${time} üìã REVIEWER (${json.agent_id}) - Plan: ${json.plan}`;
                        } else if (json.event === 'reviewer_step_start') {
                            eventDiv.textContent = `${time} üîπ REVIEWER (${json.agent_id}) - ${json.description}...`;
                        } else if (json.event === 'reviewer_step_complete') {
                            // Review step shows blocking/non-blocking issues
                            const icon = json.passed ? '‚úÖ' : '‚ùå';
                            eventDiv.innerHTML = `${time} ${icon} REVIEWER (${escapeHtml(json.agent_id)}) - ${escapeHtml(json.step)}: ${escapeHtml(json.message)}`;

                            // Show blocking issues if any
                            if (json.blocking_issues && json.blocking_issues.length > 0) {
                                const issuesList = json.blocking_issues.map(i =>
                                    `<div style="margin-left: 20px; color: #f44336;">‚õî ${escapeHtml(i.message)}${i.suggestion ? ': ' + escapeHtml(i.suggestion) : ''}</div>`
                                ).join('');
                                eventDiv.innerHTML += issuesList;
                            }

                            // Show non-blocking issues if any
                            if (json.nonblocking_issues && json.nonblocking_issues.length > 0) {
                                const nitsList = json.nonblocking_issues.map(i =>
                                    `<div style="margin-left: 20px; color: #ffc107;">üí° ${escapeHtml(i.message)}${i.suggestion ? ': ' + escapeHtml(i.suggestion) : ''}</div>`
                                ).join('');
                                eventDiv.innerHTML += nitsList;
                            }

                            if (!json.passed) {
                                eventDiv.className = 'event error';
                            }
                        } else if (json.event === 'reviewer_complete') {
                            const icon = json.passed ? '‚úÖ' : '‚ùå';
                            eventDiv.innerHTML = `${time} ${icon} REVIEWER (${escapeHtml(json.agent_id)}) - ${escapeHtml(json.message)}`;

                            // Show blocking issues summary
                            if (json.blocking_issues && json.blocking_issues.length > 0) {
                                const issuesList = json.blocking_issues.slice(0, 3).map(msg =>
                                    `<div style="margin-left: 20px; color: #f44336;">‚õî ${escapeHtml(msg)}</div>`
                                ).join('');
                                eventDiv.innerHTML += issuesList;
                            }

                            if (!json.passed) eventDiv.className = 'event error';
                        }
                        // ========== DocGen Events ==========
                        else if (json.event === 'docgen_start') {
                            eventDiv.textContent = `${time} üìù DOCGEN (${json.agent_id}) - Adding documentation to ${json.code_lines} lines...`;
                        } else if (json.event === 'docgen_complete') {
                            eventDiv.textContent = `${time} ‚úÖ DOCGEN (${json.agent_id}) - Added README (${json.readme_lines} lines)`;
                        }
                        // ========== Reflection Events ==========
                        else if (json.event === 'reflection_start') {
                            const issueList = json.issues.slice(0, 2).join('; ');
                            eventDiv.textContent = `${time} üîÑ REFLECTION - ${json.blocking_issues} blocking issue(s), retrying... (${json.attempt}/${json.max_attempts})`;
                            eventDiv.className = 'event retry';
                        }
                        // ========== Legacy Plan Events (Module 11) ==========
                        else if (json.event === 'plan_start') {
                            document.getElementById('plan-section').style.display = 'block';
                            document.getElementById('plan-info').innerHTML = `<strong>Task:</strong> ${escapeHtml(json.task)}`;
                            eventDiv.textContent = `${time} üìã PLAN START - ${json.task}`;
                        } else if (json.event === 'plan_analysis') {
                            const complexity = json.is_complex ? 'Complex' : 'Simple';
                            document.getElementById('plan-info').innerHTML += `<br><strong>Analysis:</strong> ${complexity} task (${json.word_count} words)`;
                            eventDiv.textContent = `${time} üîç ANALYSIS - ${complexity} task (${json.word_count} words)`;
                        } else if (json.event === 'plan_step_identified') {
                            const deps = json.depends_on.length > 0 ? ` [depends: ${json.depends_on.join(', ')}]` : '';
                            eventDiv.textContent = `${time} üìå STEP: ${json.step_id} - ${json.task}${deps}`;
                        } else if (json.event === 'plan_complete') {
                            document.getElementById('plan-info').innerHTML += `<br><strong>Steps:</strong> ${json.total_steps} | <strong>Parallel stages:</strong> ${json.parallel_stages}`;

                            // Render Mermaid diagram
                            if (json.mermaid) {
                                const diagramDiv = document.getElementById('plan-diagram');
                                const mermaidId = 'mermaid-' + Date.now();
                                diagramDiv.innerHTML = `<pre class="mermaid" id="${mermaidId}">${json.mermaid}</pre>`;
                                try {
                                    mermaid.init(undefined, document.getElementById(mermaidId));
                                } catch (e) {
                                    console.error('Mermaid error:', e);
                                }
                            }

                            eventDiv.textContent = `${time} ‚úÖ PLAN COMPLETE - ${json.total_steps} steps, ${json.parallel_stages} parallel stages`;
                            setStatus('running', 'Executing...');
                        }
                        // ========== Legacy Code Agent Events ==========
                        else if (json.event === 'node_start') {
                            eventDiv.textContent = `${time} üîµ ${json.node.toUpperCase()} - ${json.message}`;
                        } else if (json.event === 'node_complete') {
                            eventDiv.textContent = `${time} ‚úÖ ${json.node.toUpperCase()} - ${json.message} (${json.duration_ms.toFixed(0)}ms)`;
                            // Update metrics
                            const metricId = json.node + 'Time';
                            const metricEl = document.getElementById(metricId);
                            if (metricEl) metricEl.textContent = json.duration_ms.toFixed(0);
                        } else if (json.event === 'retry') {
                            eventDiv.textContent = `${time} üîÑ RETRY ${json.attempt}/${json.max_attempts} - ${json.reason}`;
                        }
                        // ========== Final Result ==========
                        else if (json.event === 'result') {
                            const isSuccess = json.status === 'completed';
                            const icon = isSuccess ? 'üéâ' : '‚ùå';
                            eventDiv.textContent = `${time} ${icon} ${json.status.toUpperCase()} (${json.total_duration_ms.toFixed(0)}ms)`;
                            if (json.error) {
                                eventDiv.textContent += ` - ${json.error}`;
                            }
                            if (!isSuccess) eventDiv.className = 'event error';

                            // Set code and apply syntax highlighting
                            const codeEl = document.querySelector('#code code');
                            codeEl.textContent = json.generated_code || 'No code generated';
                            Prism.highlightElement(codeEl);

                            setStatus(isSuccess ? 'success' : 'error', json.status.toUpperCase());
                        } else if (json.event === 'error') {
                            eventDiv.textContent = `${time} ‚ùå ERROR - ${json.error}`;
                            setStatus('error', 'Error');
                        }
                        // ========== Unknown Events (show raw) ==========
                        else {
                            eventDiv.textContent = `${time} üìå ${json.event.toUpperCase()} - ${JSON.stringify(json).slice(0, 100)}...`;
                        }

                        eventsDiv.appendChild(eventDiv);
                        eventsDiv.scrollTop = eventsDiv.scrollHeight;
                    }
                }
            } catch (err) {
                eventsDiv.innerHTML += `<div class="event error">‚ùå Connection Error: ${err.message}</div>`;
                setStatus('error', 'Connection Error');
            }
        }

        async function runCode() {
            const code = document.querySelector('#code code').textContent;
            if (code === 'Waiting for result...' || !code.trim()) {
                document.getElementById('output').innerHTML = '<span class="output-error">No code to run. Generate code first.</span>';
                document.getElementById('output-time').textContent = '';
                return;
            }

            document.getElementById('output').textContent = 'Running...';
            document.getElementById('output-time').textContent = '';

            try {
                const response = await fetch('/api/tasks/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });

                const result = await response.json();
                const outputDiv = document.getElementById('output');
                const timeDiv = document.getElementById('output-time');

                if (result.success) {
                    outputDiv.innerHTML = '<span class="output-success">' + escapeHtml(result.output) + '</span>';
                } else {
                    outputDiv.innerHTML = '<span class="output-error">' + escapeHtml(result.error || result.output) + '</span>';
                }
                timeDiv.textContent = 'Execution time: ' + result.execution_time_ms + 'ms';
            } catch (err) {
                document.getElementById('output').innerHTML = '<span class="output-error">Error: ' + escapeHtml(err.message) + '</span>';
                document.getElementById('output-time').textContent = '';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
